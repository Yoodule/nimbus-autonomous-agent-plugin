#!/bin/bash

# Nimbus - Multi-Task Autonomous Agent Setup
# Adds tasks to queue for autonomous development loop
# When invoked, Claude stays in loop processing queued tasks

set -euo pipefail

# Source queue utilities
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "$(dirname "${BASH_SOURCE[0]}")/../lib/queue-utils.sh"

# Parse arguments
PROMPT_PARTS=()
MAX_ITERATIONS=0
COMPLETION_PROMISE=""
DEPENDS_ON=""
TASK_ID=""
TASK_NAME=""

# Parse options and positional arguments
while [[ $# -gt 0 ]]; do
  case $1 in
    -h|--help)
      cat << 'HELP_EOF'
Nimbus - Multi-Task Autonomous Agent

USAGE:
  /nimbus [PROMPT...] [OPTIONS]

ARGUMENTS:
  PROMPT...    Initial prompt for task (can be multiple words)

OPTIONS:
  --task-id <id>                Unique task ID (auto-generated if not provided)
  --name <name>                 Task name for display (auto-generated if not provided)
  --max-iterations <n>          Maximum iterations before auto-stop (default: 50)
  --completion-promise '<text>' Promise phrase to signal completion (REQUIRED)
  --depends-on <id[,id,...]>    Task IDs this task depends on (comma-separated)
  -h, --help                    Show this help message

DESCRIPTION:
  Adds a new autonomous task to the Nimbus work queue. The task will be
  activated when all its dependencies are completed. Tasks are processed
  sequentially by the stop hook until completion promise is detected.

COMPLETION PROMISE:
  Must be a phrase that becomes TRUE when the task is done. Output it as:
    <promise>YOUR_PHRASE</promise>

  Examples:
    <promise>All tests passing</promise>
    <promise>Deployment complete</promise>
    <promise>SETUP_COMPLETE</promise>

EXAMPLES:
  /nimbus Fix all failing tests --completion-promise 'All tests passing'
  /nimbus Deploy to staging --depends-on 1 --completion-promise 'Deployment complete'
  /nimbus --task-id smoke-tests Verify endpoints --completion-promise 'Smoke tests pass'

TASK DEPENDENCIES:
  Tasks wait for dependencies to complete before starting:
    /nimbus Run tests --task-id test --completion-promise 'Tests pass'
    /nimbus Deploy --depends-on test --completion-promise 'Deployed'

  Second task only runs after first completes.

MONITORING:
  View queue status:
    /nimbus-status

  Stop a task:
    /nimbus-stop <task-id>
HELP_EOF
      exit 0
      ;;
    --task-id)
      if [[ -z "${2:-}" ]]; then
        echo "âŒ Error: --task-id requires an ID argument" >&2
        exit 1
      fi
      TASK_ID="$2"
      shift 2
      ;;
    --name)
      if [[ -z "${2:-}" ]]; then
        echo "âŒ Error: --name requires a name argument" >&2
        exit 1
      fi
      TASK_NAME="$2"
      shift 2
      ;;
    --max-iterations)
      if [[ -z "${2:-}" ]]; then
        echo "âŒ Error: --max-iterations requires a number argument" >&2
        exit 1
      fi
      if ! [[ "$2" =~ ^[0-9]+$ ]]; then
        echo "âŒ Error: --max-iterations must be a positive integer, got: $2" >&2
        exit 1
      fi
      MAX_ITERATIONS="$2"
      shift 2
      ;;
    --completion-promise)
      if [[ -z "${2:-}" ]]; then
        echo "âŒ Error: --completion-promise requires a text argument" >&2
        exit 1
      fi
      COMPLETION_PROMISE="$2"
      shift 2
      ;;
    --depends-on)
      if [[ -z "${2:-}" ]]; then
        echo "âŒ Error: --depends-on requires task ID(s) argument" >&2
        exit 1
      fi
      DEPENDS_ON="$2"
      shift 2
      ;;
    *)
      # Non-option argument - collect all as prompt parts
      PROMPT_PARTS+=("$1")
      shift
      ;;
  esac
done

# Join all prompt parts with spaces
PROMPT="${PROMPT_PARTS[*]}"

# Validate prompt is non-empty
if [[ -z "$PROMPT" ]]; then
  echo "âŒ Error: No prompt provided" >&2
  echo "" >&2
  echo "   Nimbus needs a task description to work on." >&2
  echo "" >&2
  echo "   Examples:" >&2
  echo "     /nimbus Fix all failing tests --completion-promise 'Tests pass'" >&2
  echo "     /nimbus Deploy to staging --completion-promise 'Deployed'" >&2
  echo "" >&2
  echo "   For all options: /nimbus --help" >&2
  exit 1
fi

# Validate completion promise
if [[ -z "$COMPLETION_PROMISE" ]]; then
  echo "âŒ Error: --completion-promise is REQUIRED" >&2
  echo "" >&2
  echo "   Nimbus needs a completion phrase to know when the task is done." >&2
  echo "" >&2
  echo "   Example:" >&2
  echo "     --completion-promise 'All tests passing'" >&2
  echo "" >&2
  echo "   Output this as: <promise>All tests passing</promise>" >&2
  exit 1
fi

# Generate task ID if not provided
if [[ -z "$TASK_ID" ]]; then
  # Use incremental ID based on existing tasks
  queue_init
  NEXT_ID=$(($(jq '.tasks | length' .claude/plugins/nimbus/nimbus-queue.json) + 1))
  TASK_ID="$NEXT_ID"
fi

# Generate task name if not provided
if [[ -z "$TASK_NAME" ]]; then
  TASK_NAME="${PROMPT:0:40}"
  if [[ ${#PROMPT} -gt 40 ]]; then
    TASK_NAME="${TASK_NAME}..."
  fi
fi

# Set default max iterations
if [[ $MAX_ITERATIONS -eq 0 ]]; then
  MAX_ITERATIONS=50
fi

# Add task to queue
queue_add_task "$TASK_ID" "$TASK_NAME" "$PROMPT" "$MAX_ITERATIONS" "$COMPLETION_PROMISE" "$DEPENDS_ON"

# Output confirmation
cat <<EOF
ðŸš€ Task added to Nimbus queue!

Task ID:              $TASK_ID
Name:                 $TASK_NAME
Max iterations:       $MAX_ITERATIONS
Completion promise:   $COMPLETION_PROMISE
Dependencies:         $(if [[ -n "$DEPENDS_ON" ]]; then echo "$DEPENDS_ON"; else echo "none"; fi)

Status: queued
$(if [[ -n "$DEPENDS_ON" ]]; then echo "Waiting for: $DEPENDS_ON"; fi)

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

View queue status:
  /nimbus-status

Stop this task:
  /nimbus-stop $TASK_ID

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
EOF
